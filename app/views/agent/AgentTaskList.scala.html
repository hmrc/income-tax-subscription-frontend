@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.AppConfig
@import models.common.TaskListModel
@import models.common.business.{BusinessNameModel, BusinessTradeNameModel}
@import services.AccountingPeriodService
@import views.html.helpers.injected.ContinueButton
@import views.html.helpers.injected.ButtonHelper
@import views.html.templates.AgentMainTemplate

@this(
    mainTemplate: AgentMainTemplate,
    form: FormWithCSRF,
    continueButton: ContinueButton,
    accountingPeriodService: AccountingPeriodService,
    saveAndContinueButton: ButtonHelper,
    govukTag : GovukTag
)

@(postAction: Call, viewModel: TaskListModel, clientName: String, clientNino: String)(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@taskListScripts = {
  <script src='@controllers.routes.Assets.versioned("javascripts/task-list.js")'></script>
}

@messagePrefix = @{"agent.business.task-list"}

@signUpSectionContent = @{
  if(viewModel.taskListComplete ) {
    continueButton(Some(messages("base.submit-and-continue")))
  } else {
    <p>
      {messages(s"${messagePrefix}.content.action-needed")}
    </p>
  }
}

@saveAndComeBackButton = @{
  saveAndContinueButton(messages("base.save-and-come-back-later"), Some("govuk-button--secondary"), Some(controllers.agent.business.routes.ProgressSavedController.show(Some("Task-List")).url))
}

@applicationStatus = @{
  if(viewModel.taskListComplete) {
    messages(s"${messagePrefix}.heading.complete")
  } else {
    messages(s"${messagePrefix}.heading.incomplete")
  }
}

@businessName(index: Int, businessName: Option[BusinessNameModel], businessTradeName: Option[BusinessTradeNameModel]) = @{
  (businessName, businessTradeName) match {
    case (None, None) => messages(s"${messagePrefix}.content.section2.business", index + 1)
    case (None, Some(businessTradeNameModel)) => businessTradeNameModel.businessTradeName
    case (Some(businessNameModel), None) => businessNameModel.businessName
    case (Some(businessNameModel), Some(businessTradeNameModel)) => s"${businessNameModel.businessName} ${businessTradeNameModel.businessTradeName}"
  }
}

@taxYearText = @{
  viewModel.taxYearSelection.map(_.accountingYear) match {
      case Some(Current) => messages(s"${messagePrefix}.content.section1.current-tax-year", (accountingPeriodService.currentTaxYear - 1).toString, accountingPeriodService.currentTaxYear.toString)
      case Some(Next) => messages(s"${messagePrefix}.content.section1.next-tax-year", accountingPeriodService.currentTaxYear.toString, (accountingPeriodService.currentTaxYear + 1).toString)
      case None => messages(s"${messagePrefix}.content.section1.action")
  }
}

@selectTaxYear = {
<ul class="app-task-list__items">
  <li class="app-task-list__item">
    <span class="app-task-list__task-name">
      @{if(viewModel.taxYearSelectedAndConfirmed) {
        if(!viewModel.permitTaxYearChange)
          taxYearText
        else {
          <a href={controllers.agent.routes.TaxYearCheckYourAnswersController.show(editMode=true).url} aria-describedby="section_1_thing_1_status" id="select_tax_year_check_your_answer">
            {taxYearText}
          </a>
        }
      } else if (viewModel.taxYearSelectedNotConfirmed) {
      <a href={controllers.agent.routes.WhatYearToSignUpController.show().url} aria-describedby="section_1_thing_1_status" id="select_tax_year_not_confirmed">
          {messages(s"${messagePrefix}.content.section1.action")}
      </a>

      } else {
      <a href={controllers.agent.routes.WhatYearToSignUpController.show().url} aria-describedby="section_1_thing_1_status" id="select_tax_year">
         {messages(s"${messagePrefix}.content.section1.action")}
      </a>
      }}
    </span>
    <span class="app-task-list__task-completed" id="section_1_thing_1_status">
      @{if(viewModel.taxYearSelectedAndConfirmed) {
          govukTag(Tag(
            content = Text(messages(s"${messagePrefix}.status.completed"))
          ))
        } else if (viewModel.taxYearSelectedNotConfirmed) {
          govukTag(Tag(
            content = Text(messages(s"${messagePrefix}.status.in-progress")), classes = "govuk-tag--grey"
          ))
        } else {
          govukTag(Tag(
            content = Text(messages(s"${messagePrefix}.status.not-started")), classes = "govuk-tag--grey"
          ))
        }
      }
    </span>
  </li>
</ul>

}

@addBusiness = @{if(viewModel.canAddMoreBusinesses(appConfig.maxSelfEmployments)) {
<div class="app-task-list__items">
  <a href={controllers.agent.routes.WhatIncomeSourceToSignUpController.show().url} id="add_business" class="govuk-link">
    {messages(s"${messagePrefix}.content.section2.add")}
  </a>
</div>
}}

@businesses = @{if(viewModel.selfEmployments.nonEmpty || viewModel.ukProperty.isDefined || viewModel.overseasProperty.isDefined) {
  <ul class="app-task-list__items govuk-!-margin-bottom-3">
    {viewModel.selfEmployments.map(se =>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name">
        <a href={s"${appConfig.agentIncomeTaxSelfEmploymentsFrontendBusinessCheckYourAnswersUrl}?id=${se.id}&isEditMode=true"} aria-describedby={"section_2_item_1_status"+viewModel.selfEmployments.indexOf(se)}>
        {businessName(viewModel.selfEmployments.indexOf(se), se.businessName, se.businessTradeName)}
        </a>
      </span>
      <span class="app-task-list__task-completed" id={"section_2_item_1_status"+viewModel.selfEmployments.indexOf(se)}>
      {if(se.confirmed && viewModel.selfEmploymentAccountingMethod.isDefined) {
          <strong class = "govuk-tag">{messages(s"${messagePrefix}.status.completed")}</strong>
        } else {
          <strong class = "govuk-tag govuk-tag--grey">{messages(s"${messagePrefix}.status.incomplete")}</strong>
        }
      }
      </span>
      <span class="govuk-remove-business-link" id={"self_employment_remove"+viewModel.selfEmployments.indexOf(se)}>
        <a class="govuk-link" href={controllers.agent.business.routes.RemoveBusinessController.show(se.id).url}>
          <span aria-hidden="true">{messages("base.remove")}</span>
          <span class="govuk-visually-hidden">
          {messages(s"${messagePrefix}.content.section2.remove-sole-trader-business", businessName(viewModel.selfEmployments.indexOf(se), se.businessName, se.businessTradeName))}
          </span>
        </a>
      </span>
    </li>
    )}

    {viewModel.ukProperty.map(ukps =>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name">
        <a href={controllers.agent.business.routes.PropertyCheckYourAnswersController.show(editMode=true).url} aria-describedby="uk_property_status" id="uk_property_business">{messages(s"${messagePrefix}.content.section2.property.uk")}</a>
      </span>
      <span class="app-task-list__task-completed" id="uk_property_status">
      {if(viewModel.ukPropertyComplete ) {
          <strong class = "govuk-tag">{messages(s"${messagePrefix}.status.completed")}</strong>
        } else {
          <strong class = "govuk-tag govuk-tag--grey">{messages(s"${messagePrefix}.status.incomplete")}</strong>
        }
      }
      </span>
      <span class="govuk-remove-business-link" id="uk_property_remove">
        <a class="govuk-link" href={controllers.agent.business.routes.RemoveUkPropertyController.show.url}>
          <span aria-hidden="true">{messages("base.remove")}</span>
          <span aria-hidden="false" class="govuk-visually-hidden">{messages(s"${messagePrefix}.content.section2.remove-uk-property")}</span>
        </a>
      </span>
    </li>
    ).getOrElse({})}

    {viewModel.overseasProperty.map(_ =>
    <li class="app-task-list__item">
      <span class="app-task-list__task-name">
        <a href={controllers.agent.business.routes.OverseasPropertyCheckYourAnswersController.show(editMode=true).url} aria-describedby="overseas_property_status" id="overseas_property_business">{messages(s"${messagePrefix}.content.section2.property.overseas")}</a>
      </span>
      <span class="app-task-list__task-completed" id="overseas_property_status">
      {if(viewModel.overseasPropertyComplete) {
          <strong class = "govuk-tag">{messages(s"${messagePrefix}.status.completed")}</strong>
        } else {
          <strong class = "govuk-tag govuk-tag--grey">{messages(s"${messagePrefix}.status.incomplete")}</strong>
        }
      }
      </span>
      <span class="govuk-remove-business-link" id="overseas_property_remove">
        <a class="govuk-link" href={controllers.agent.business.routes.RemoveOverseasPropertyController.show.url}>
          <span aria-hidden="true">{messages("base.remove")}</span>
          <span class="govuk-visually-hidden">{messages(s"${messagePrefix}.content.section2.remove-overseas-property")}</span>
        </a>
      </span>
    </li>
    ).getOrElse({})}
  </ul>
}}

@mainTemplate(title = messages(s"${messagePrefix}.title"), additionalScripts = Some(taskListScripts)) {
  <h1 class="govuk-heading-xl">@messages(s"${messagePrefix}.title")</h1>

  <p class="govuk-body client-details govuk-!-padding-5 govuk-!-border-0" id ="userNameNino">
    @{messages(s"${messagePrefix}.client")} @clientName | @clientNino
  </p>

  <h2 class="govuk-heading-m govuk-!-margin-bottom-2 govuk-!-margin-top-2" id ="taskListStatus" >@applicationStatus</h2>

  <p class=" app-task-list__item govuk-body govuk-!-padding-bottom-7" id ="taskListCompletedSummary">@messages(s"${messagePrefix}.content.summary", viewModel.sectionsComplete, viewModel.sectionsTotal)</p>

  <div class="govuk-form-group govuk-!-padding-top-7">
    @form(action = postAction) {
      <ol class="app-task-list">
        <li>
          <h2 class="app-task-list__section govuk-heading-m">
            <span class="app-task-list__section-number">1.</span>
            @messages(s"${messagePrefix}.content.section1")
          </h2>
          @selectTaxYear
        </li>
        <li>
          <h2 class="app-task-list__section">
              <span class="app-task-list__section-number govuk-heading-m">2.</span>
              @messages(s"${messagePrefix}.content.section2")
          </h2>
          <ul class="app-task-list__items govuk-!-margin-bottom-6">
            <li class="border-none">
              <p class="govuk-body">
                @messages(s"${messagePrefix}.content.section2.para", appConfig.maxSelfEmployments)
              </p>
            </li>
          </ul>
          @businesses
          @addBusiness
        </li>
        <li>
          <h2 class="app-task-list__section govuk-heading-m">
            <span class="app-task-list__section-number">3.</span>
            @messages(s"${messagePrefix}.content.section3")
          </h2>
          <ul class="app-task-list__items">
            <li class="border-none">
              @signUpSectionContent
              @saveAndComeBackButton
            </li>
          </ul>
        </li>
      </ol>
    }
  </div>
}