@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.featureswitch.FeatureSwitchingImpl
@import config.featureswitch.FeatureSwitch.ForeignProperty
@import views.html.templates.AgentMainTemplate
@import views.html.helpers.injected.RadioHelper
@import views.html.helpers.injected.ContinueButton
@import forms.agent.HaveYouCompletedThisSectionForm
@import models.common.BusinessIncomeSource
@import config.AppConfig
@import models.common._
@import models.common.business._
@import forms.agent.BusinessIncomeSourceForm
@import controllers.agent.business.PropertyStartDateController
@import utilities.UserMatchingSessionUtil.ClientDetails
@import uk.gov.hmrc.hmrcfrontend.views.html.components._
@import utilities.UserMatchingSessionUtil.ClientDetails

@this(
  agentMainTemplate: AgentMainTemplate,
  appConfig: AppConfig,
  form: FormWithCSRF,
  radioHelper: RadioHelper,
  continueButton: ContinueButton,
  featureSwitching: FeatureSwitchingImpl,
  hmrcListWithActions : HmrcListWithActions
)

@(postAction: Call, backUrl: String, haveYouCompletedThisSectionForm: Form[YesNo], clientDetails: ClientDetails, selfEmployments: Seq[SelfEmploymentData], ukProperty:
Option[PropertyModel], foreignProperty: Option[OverseasPropertyModel])(implicit request:
Request[_], messages: Messages)


@selfEmploymentLabel(business: SelfEmploymentData, index: Int) = @{
    (business.businessName, business.businessTradeName) match {
        case (Some(BusinessNameModel(name)), Some(BusinessTradeNameModel(trade))) => messages("agent.your-income-source.self-employed.label-full", trade, name)
        case (Some(BusinessNameModel(name)), None) => name
        case (None, Some(BusinessTradeNameModel(trade))) => trade
        case _ => messages("agent.your-income-source.self-employed.label-none", index)
    }
}

@selfEmploymentSection = {

<h2 class="govuk-heading-m">@messages("agent.your-income-source.self-employed")</h2>




@hmrcListWithActions(ListWithActions(
    items = selfEmployments.zip(1 to selfEmployments.length).map { case (business, index) =>
        ListWithActionsItem(
            name = Text(selfEmploymentLabel(business, index)),
            actions = Seq(
                ListWithActionsAction(
                    href = s"${appConfig.agentIncomeTaxSelfEmploymentsFrontendBusinessCheckYourAnswersUrl}?id=${business.id}&isEditMode=true",
                    content = Text(messages("base.change")),
                    visuallyHiddenText = Some(messages("agent.your-income-source.self-employed.change-hidden", selfEmploymentLabel(business, index))),
                ),
                ListWithActionsAction(
                href = controllers.agent.business.routes.RemoveBusinessController.show(business.id).url,
                content = Text(messages("base.remove")),
                visuallyHiddenText = Some(messages("agent.your-income-source.self-employed.remove-hidden", selfEmploymentLabel(business, index))),
                )
            )
        )
    }
))

<div id="add-self-employment" class="govuk-!-padding-bottom-6">
    <a class="govuk-link" href="@appConfig.incomeTaxSelfEmploymentsFrontendClientInitialiseUrl">
        @if(selfEmployments.isEmpty) {
            @messages("agent.your-income-source.self-employed-link")
        } else {
            @messages("agent.your-income-source.self-employed.add-another-link")
        }
    </a>
</div>

}

@ukPropertySection = {

<h2 class="govuk-heading-m">@messages("agent.your-income-source.uk-property")</h2>


    @if(ukProperty.isDefined) {
        @hmrcListWithActions(ListWithActions(
        items = ukProperty.map { property =>
            ListWithActionsItem(
            name = Text(messages("agent.your-income-source.uk-property.label")),
            actions = Seq(
                ListWithActionsAction(
                href = controllers.agent.business.routes.PropertyCheckYourAnswersController.show(editMode = true).url,
                content = Text(messages("base.change")),
                visuallyHiddenText = Some(messages("agent.your-income-source.uk-property.change-hidden")),
                ),
                ListWithActionsAction(
                href = controllers.agent.business.routes.RemoveUkPropertyController.show.url,
                content = Text(messages("base.remove")),
                visuallyHiddenText = Some(messages("agent.your-income-source.uk-property.remove-hidden")),
                )
            )
        )
    }.toSeq
    ))
    } else {
        <div id="add-uk-property" class="govuk-!-padding-bottom-6">
            <a class="govuk-link" href="@controllers.agent.business.routes.PropertyStartDateController.show()">@messages("agent.your-income-source.uk-property.add-link")</a>
        </div>
    }

}


@foreignPropertySection = {

    <h2 class="govuk-heading-m">@messages("agent.your-income-source.foreign-property")</h2>

    @if(foreignProperty.isDefined) {
        @hmrcListWithActions(ListWithActions(
            items = foreignProperty.map { property =>
                ListWithActionsItem(
                    name = Text(messages("agent.your-income-source.foreign-property.label")),
                    actions = Seq(
                        ListWithActionsAction(
                            href = controllers.agent.business.routes.OverseasPropertyCheckYourAnswersController.show(editMode = true).url,
                            content = Text(messages("base.change")),
                            visuallyHiddenText = Some(messages("agent.your-income-source.foreign-property.change-hidden")),
                        ),
                ListWithActionsAction(
                    href = controllers.agent.business.routes.RemoveOverseasPropertyController.show.url,
                    content = Text(messages("base.remove")),
                    visuallyHiddenText = Some(messages("agent.your-income-source.foreign-property.remove-hidden")),
                    )
                )
            )
    }.toSeq
    ))
} else {
    <div id="add-foreign-property" class="govuk-!-padding-bottom-6">
        <a class="govuk-link" href="@controllers.agent.business.routes.OverseasPropertyStartDateController.show()">@messages("agent.your-income-source.foreign-property.add-link")</a>
    </div>
}

}

@yesNoRadios() = {
    @radioHelper(
        field = haveYouCompletedThisSectionForm(HaveYouCompletedThisSectionForm.fieldName),
        legend = messages("agent.your-income-source.completed.form.heading"),
        isPageHeading = false,
        headingClasses = "govuk-!-font-weight-bold",
        radioItems = Seq(
            RadioItem(
                content = Text(messages("agent.your-income-source.completed.form.yes")),
                value = Some(Yes.toString)
            ),
            RadioItem(
                content = Text(messages("agent.your-income-source.completed.form.no")),
                value = Some(No.toString)
            )
        )
    )
}


@agentMainTemplate(
    title = messages("agent.your-income-source.title"),
    optForm = Some(haveYouCompletedThisSectionForm),
    backLink = Some(backUrl)
) {
    <span class="govuk-caption-l">
        @messages("agent.your-income-source.caption", clientDetails.name, clientDetails.formattedNino)
    </span>

    <h1 class="govuk-heading-xl">@messages("agent.your-income-source.heading")</h1>

    <p class="govuk-body-l">@messages("agent.your-income-source.heading2") </p>

    @selfEmploymentSection

    @ukPropertySection

    @if(featureSwitching.isEnabled(ForeignProperty)) {
        @foreignPropertySection
    }

    @form(action = postAction) {
        <div class="govuk-form-group">
            @yesNoRadios()
            <div class="govuk-body">
                @continueButton()
            </div>
        </div>
    }
}
