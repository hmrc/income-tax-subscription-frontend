@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.AppConfig
@import models.common.TaskListModel
@import services.AccountingPeriodService
@import views.html.helpers.injected.ContinueButton
@import views.html.templates.PrincipalMainTemplate

@this(
    mainTemplate: PrincipalMainTemplate,
    form: FormWithCSRF,
    continueButton: ContinueButton
)


@(postAction: Call, viewModel: TaskListModel, accountingPeriodService: AccountingPeriodService)(implicit request: Request[_], messages: Messages, appConfig: AppConfig)

@signUpSectionContent = @{
    if(viewModel.taskListComplete ) {
        continueButton()
    } else {
            <span class="app-task-list__task-name">
                {messages("business.task-list.content.action-needed", messages("business.task-list.content.section2"))}
            </span>
    }
}

@applicationStatus = @{
    if(viewModel.taskListComplete) {
        messages("business.task-list.heading.complete")
    }else{
        messages("business.task-list.heading.incomplete")
    }
}

@businesses = @{

        <ul class="app-task-list__items">
        {viewModel.selfEmployments.map(se =>
            <li class="app-task-list__item">
            <span class="app-task-list__task-name">
            <a href={s"${appConfig.incomeTaxSelfEmploymentsFrontendBusinessCheckYourAnswersUrl}?id=${se.id}&isEditMode=true"} aria-describedby={"section_2_item_1_status"+viewModel.selfEmployments.indexOf(se)}>{se.businessName.map(bn => bn.businessName).getOrElse("")} {se.businessTradeName.map(btn => btn.businessTradeName).getOrElse("")}</a>
            </span>
            <span class="app-task-list__task-completed" id={"section_2_item_1_status"+viewModel.selfEmployments.indexOf(se)}>
             {if(se.confirmed && viewModel.selfEmploymentAccountingMethod.isDefined) {messages("business.task-list.status.completed")} else {messages("business.task-list.status.incomplete")}}
            </span>
            </li>
            )}

        {viewModel.ukProperty.map(ukps =>
            <li class="app-task-list__item">
            <span class="app-task-list__task-name">
            <a href={controllers.individual.business.routes.PropertyCheckYourAnswersController.show(editMode=true).url} aria-describedby="uk_property_status" id="uk_property_business">{messages("business.task-list.content.section2.property.uk")}</a>
            </span>
            <span class="app-task-list__task-completed" id="uk_property_status">
            {if(viewModel.ukPropertyComplete ) {messages("business.task-list.status.completed")} else {messages("business.task-list.status.incomplete")}}
            </span>
            </li>

            ).getOrElse({})}
        {viewModel.overseasProperty.map(_ =>
            <li class="app-task-list__item">
            <span class="app-task-list__task-name">
            <a href={controllers.individual.business.routes.OverseasPropertyCheckYourAnswersController.show(editMode=true).url} aria-describedby="overseas_property_status" id="overseas_property_business">{messages("business.task-list.content.section2.property.overseas")}</a>
            </span>
            <span class="app-task-list__task-completed" id="overseas_property_status">
            {if(viewModel.overseasPropertyComplete) {messages("business.task-list.status.completed")} else {messages("business.task-list.status.incomplete")}}
            </span>
            </li>
        ).getOrElse({})}{if(viewModel.canAddMoreBusinesses) {
                <li class="app-task-list__item">
                <span class="app-task-list__task-name">
                <a href={controllers.individual.incomesource.routes.WhatIncomeSourceToSignUpController.show.url} aria-describedby="section_2_action" id="add_business">{messages("business.task-list.content.section2.action")}</a>
                </span>
                </li>
        }}
        </ul>
}

@selectTaxYear = @{
        <ul class="app-task-list__items">
            <li class="app-task-list__item">
                <span class="app-task-list__task-name">
                    {if(viewModel.taxYearSelectedAndConfirmed) {
                    <a href={controllers.individual.business.routes.TaxYearCheckYourAnswersController.show().url} aria-describedby="section_1_item_1_status" id="select_tax_year_check_your_answer">
                        {
                        viewModel.taxYearSelection.map(_.accountingYear) match {
                            case Some(Current) => messages("business.task-list.content.section1.current-tax-year", (accountingPeriodService.currentTaxYear - 1).toString, accountingPeriodService.currentTaxYear.toString)
                            case Some(Next) => messages("business.task-list.content.section1.next-tax-year", accountingPeriodService.currentTaxYear.toString, (accountingPeriodService.currentTaxYear + 1).toString)
                            case None => messages("business.task-list.content.section1.action")
                        }
                        }
                    </a>
                    } else if (viewModel.taxYearSelectedNotConfirmed) {
                    <a href={controllers.individual.business.routes.WhatYearToSignUpController.show().url} aria-describedby="section_1_item_1_status" id="select_tax_year_not_confirmed">
                        {messages("business.task-list.content.section1.action")}
                    </a>

                    } else {
                    <a href={controllers.individual.business.routes.WhatYearToSignUpController.show().url} aria-describedby="section_1_item_1_status" id="select_tax_year">
                        {messages("business.task-list.content.section1.action")}
                    </a>
                    }
                    }
                </span>
                <span class="app-task-list__task-completed" id="section_1_thing_1_status">
                    {
                    if(viewModel.taxYearSelectedAndConfirmed) {
                        messages("business.task-list.status.completed")
                    } else if (viewModel.taxYearSelectedNotConfirmed) {
                        messages("business.task-list.status.in-progress")
                    } else {
                        messages("business.task-list.status.not-started")
                    }
                    }
                </span>
            </li>
        </ul>
}

@mainTemplate(title = messages("business.task-list.title")) {

    <h1 class="govuk-heading-xl">@messages("business.task-list.title")</h1>
    <h2 class="govuk-heading-s govuk-!-margin-bottom-2">@applicationStatus</h2>
    <p class="govuk-body govuk-!-margin-bottom-7">@messages("business.task-list.content.summary", viewModel.sectionsComplete, viewModel.sectionsTotal)</p>

    <div class="govuk-form-group">
        @form(action = postAction) {
            <ol class="app-task-list">
                <li>
                    <h2 class="app-task-list__section govuk-heading-m">
                        <span class="app-task-list__section-number">
                            1.</span> @messages("business.task-list.content.section1")
                    </h2>

                    @selectTaxYear

                </li>
                <li>
                    <h2 class="app-task-list__section">
                        <span class="app-task-list__section-number govuk-heading-m">2.</span>
                        @messages("business.task-list.content.section2")
                    </h2>

                    @businesses


                </li>
                <li>
                    <h2 class="app-task-list__section govuk-heading-m">
                        <span class="app-task-list__section-number">3.</span>
                        @messages("business.task-list.content.section3")
                    </h2>
                    <ul class="app-task-list__items">
                        <li class="border-none">
                            @signUpSectionContent
                        </li>
                    </ul>

                </li>
            </ol>

        }

    </div>
}