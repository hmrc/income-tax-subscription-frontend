@*
* Copyright 2021 HM Revenue & Customs
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*@

@import config.AppConfig
@import views.html.helpers.injected.ButtonHelper
@import views.html.templates.PrincipalMainTemplate
@import services.AccountingPeriodService
@import utilities.ImplicitDateFormatterImpl

@this(
        principalMainTemplate: PrincipalMainTemplate,
        buttonHelper: ButtonHelper,
        form: FormWithCSRF,
        govukPanel: GovukPanel,
        accountingPeriodService: AccountingPeriodService,
        govukTable: GovukTable,
        implicitDateFormatter: ImplicitDateFormatterImpl
)(
        implicit appConfig: AppConfig
)

@(selectedTaxYear: Option[AccountingYear], postAction: Call)(implicit request: Request[_], messages: Messages)

@import implicitDateFormatter.LongDate

@previousUpdates(previous: List[UpdateDeadline]) = {
    @if(previous.nonEmpty) {
        <li>
            <p class="govuk-body">@messages("sign-up-complete.whatHappensNow.previous-updates")</p>
            <p class="govuk-body">@messages("sign-up-complete.whatHappensNow.no-penalty")</p>
            @govukTable(Table(
                rows = previous.map { updateDeadline =>
                    Seq(
                        TableRow(content = Text(updateDeadline.update.toLongDate)),
                        TableRow(content = Text(updateDeadline.deadline.toLongDate))
                    )
                },
                head = Some(Seq(
                    HeadCell(
                        content = Text(messages("sign-up-complete.whatHappensNow.updates-table.update-heading"))
                    ),
                    HeadCell(
                        content = Text(messages("sign-up-complete.whatHappensNow.updates-table.deadline-heading"))
                    )
                ))
            ))
        </li>
    }
}

@nextUpdates(next: List[UpdateDeadline], isNextYear: Boolean = false) = {
    <li>
        @if(isNextYear) {
            <p class="govuk-body">@messages("sign-up-complete.whatHappensNow.send-quarterly")</p>
        } else {
            <p class="govuk-body">@messages("sign-up-complete.whatHappensNow.next-updates")</p>
        }
        @govukTable(Table(
            rows = next.map { updateDeadline =>
                Seq(
                    TableRow(content = Text(updateDeadline.update.toLongDate)),
                    TableRow(content = Text(updateDeadline.deadline.toLongDate))
                )
            },
            head = Some(Seq(
                HeadCell(
                    content = Text(messages("sign-up-complete.whatHappensNow.updates-table.update-heading"))
                ),
                HeadCell(
                    content = Text(messages("sign-up-complete.whatHappensNow.updates-table.deadline-heading"))
                )
            ))
        ))
    </li>
}

@principalMainTemplate(title = messages("sign-up-complete.heading")) {

    <div class="govuk-form-group">
        @govukPanel(
            Panel(
                headingLevel = 1,
                title = Text(messages("sign-up-complete.heading"))
            )
        )
    </div>

    <h2 class="govuk-heading-m">@messages("sign-up-complete.whatHappensNow.heading")</h2>


    <ol class="govuk-list govuk-list--number">
        <li>
            @Html(messages(
                key = "sign-up-complete.whatHappensNow.number1",
                args = <a class="govuk-link" id="compatibleSoftware" href={appConfig.softwareUrl} target="_blank">{messages("sign-up-complete.whatHappensNow.number1.link")}</a>
            ))
        </li>
        @if(selectedTaxYear.contains(Next)) {
            @nextUpdates(accountingPeriodService.getAllUpdateAndDeadlineDates(Next), isNextYear = true)
            <li>@messages("sign-up-complete.whatHappensNow.submit-annual", (accountingPeriodService.currentTaxYear + 2).toString)</li>
        } else {
            @previousUpdates(accountingPeriodService.getCurrentYearUpdateDates.previous)
            @nextUpdates(accountingPeriodService.getCurrentYearUpdateDates.next)
            <li>@messages("sign-up-complete.whatHappensNow.submit-annual", (accountingPeriodService.currentTaxYear + 1).toString)</li>
        }
    </ol>

    <p class="govuk-body">
        @Html(messages(
            "sign-up-complete.whatHappensNow.para",
            <a class="govuk-link" id="btaLink" href={appConfig.btaUrl} target="_blank">{messages("sign-up-complete.whatHappensNow.para.link")}</a>
        ))
    </p>

    <p class="govuk-body">@messages("sign-up-complete.whatHappensNow.para2")</p>

    @form(action = postAction) {
        @buttonHelper(messages("sign-up-complete.whatHappensNow.signOut"))
    }

}
